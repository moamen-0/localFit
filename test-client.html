<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Frame Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        .container { display: flex; gap: 20px; }
        .panel { border: 1px solid #ddd; padding: 10px; width: 320px; }
        button { padding: 10px; margin: 5px; }
        #logContainer { height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>WebSocket Frame Test</h1>
    <button id="startCamera">Start Camera</button>
    <button id="connect">Connect to Server</button>
    <button id="sendFrame">Send Single Frame</button>
    <button id="startFrames">Start Sending Frames</button>
    <button id="stopFrames">Stop Frames</button>

    <div class="container">
        <div class="panel">
            <h3>Camera Feed</h3>
            <video id="videoElement" width="320" height="240" autoplay></video>
        </div>
        <div class="panel">
            <h3>Server Response</h3>
            <img id="responseImage" width="320" height="240" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
        </div>
    </div>

    <div>
        <p>Status: <span id="status">Not connected</span></p>
        <p>Left Counter: <span id="leftCounter">0</span></p>
        <p>Right Counter: <span id="rightCounter">0</span></p>
        <p>Feedback: <span id="feedback"></span></p>
    </div>

    <div id="logContainer">
        <h3>Logs:</h3>
        <div id="logs"></div>
    </div>

    <script>
        const serverUrl = 'https://exercisedeploy-791062084724.us-central1.run.app';
        let socket;
        let sessionId;
        let stream;
        let frameInterval;

        // DOM elements
        const videoElement = document.getElementById('videoElement');
        const responseImage = document.getElementById('responseImage');
        const statusElement = document.getElementById('status');
        const leftCounterElement = document.getElementById('leftCounter');
        const rightCounterElement = document.getElementById('rightCounter');
        const feedbackElement = document.getElementById('feedback');
        const logsElement = document.getElementById('logs');

        // Add log entry with timestamp
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsElement.appendChild(logEntry);
            logsElement.scrollTop = logsElement.scrollHeight;
        }

        // Start camera
        document.getElementById('startCamera').addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
                log('Camera started');
                statusElement.textContent = 'Camera started';
            } catch (error) {
                log(`Camera error: ${error.message}`);
                statusElement.textContent = `Error: ${error.message}`;
            }
        });

        // Connect to server
        document.getElementById('connect').addEventListener('click', () => {
            log(`Connecting to ${serverUrl}...`);
            statusElement.textContent = 'Connecting...';
            
            socket = io(serverUrl, {
                transports: ['websocket'],
                reconnection: true
            });
            
            socket.on('connect', () => {
                log('Connected to server');
                statusElement.textContent = 'Connected';
            });
            
            socket.on('session_id', (data) => {
                sessionId = data.session_id;
                log(`Session established: ${sessionId}`);
                statusElement.textContent = `Session: ${sessionId.substring(0, 8)}...`;
            });
            
            socket.on('frame', (data) => {
                if (data.image) {
                    responseImage.src = data.image;
                    leftCounterElement.textContent = data.left_counter || 0;
                    rightCounterElement.textContent = data.right_counter || 0;
                    feedbackElement.textContent = data.feedback || '';
                    log(`Received frame: L:${data.left_counter} R:${data.right_counter}`);
                }
            });
            
            socket.on('error', (data) => {
                log(`Error: ${data.message}`);
                statusElement.textContent = `Error: ${data.message}`;
            });
            
            socket.on('disconnect', () => {
                log('Disconnected from server');
                statusElement.textContent = 'Disconnected';
                if (frameInterval) {
                    clearInterval(frameInterval);
                    frameInterval = null;
                }
            });
        });

        // Send a single frame
        document.getElementById('sendFrame').addEventListener('click', () => {
            if (!socket || !sessionId || !stream) {
                log('Cannot send frame: Missing socket, session, or camera');
                return;
            }
            
            sendOneFrame();
        });

        // Start sending frames at regular intervals
        document.getElementById('startFrames').addEventListener('click', () => {
            if (!socket || !sessionId || !stream) {
                log('Cannot start frames: Missing socket, session, or camera');
                return;
            }
            
            if (frameInterval) {
                clearInterval(frameInterval);
            }
            
            log('Starting to send frames');
            frameInterval = setInterval(sendOneFrame, 100); // 5fps
        });

        // Stop sending frames
        document.getElementById('stopFrames').addEventListener('click', () => {
            if (frameInterval) {
                clearInterval(frameInterval);
                frameInterval = null;
                log('Stopped sending frames');
            }
        });

        // Function to capture and send a single frame
        function sendOneFrame() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = videoElement.videoWidth || 320;
            canvas.height = videoElement.videoHeight || 240;
            
            // Draw video frame to canvas
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            // Convert to base64
            try {
                const base64Image = canvas.toDataURL('image/jpeg', 0.7);
                
                socket.emit('frame', {
                    session_id: sessionId,
                    image: base64Image
                });
                
                log('Frame sent');
            } catch (error) {
                log(`Error sending frame: ${error.message}`);
            }
        }
    </script>
</body>
</html>